# Security Fix: Path Traversal Vulnerability in Template Handlers

## Date: 2025-11-03

## Vulnerability Summary

A critical path traversal vulnerability was identified in the nuclei template management system that allowed authenticated users to read, write, rename, and delete arbitrary files on the server filesystem.

### Severity: **CRITICAL (CVSS 9.1)**

### Affected Components

- `backend/templates/handlers.go` - All template handler functions
- Endpoints: `/api/templates/*`

### Attack Vectors

1. **Arbitrary File Read**: Using `../../../../etc/passwd` in path parameters
2. **Arbitrary File Write**: Creating files outside template directories
3. **Arbitrary File Delete**: Deleting system files
4. **Remote Code Execution**: Writing malicious files to executable locations (cron, startup scripts)
5. **Privilege Escalation**: Low-privilege users (e.g., "viewer" group) could modify templates

## Root Cause Analysis

### The Problem with `filepath.Clean()`

The original code used `filepath.Clean()` for path sanitization:

```go
cleanPath := filepath.Clean(req.Path)  // Returns "../../../../etc/passwd"
fullPath := filepath.Join(baseDir, cleanPath)  // Path escapes baseDir!
```

**Why this fails:**
- `filepath.Clean()` normalizes paths but does NOT prevent directory traversal
- `filepath.Join()` does NOT validate that the result stays within the base directory
- An attacker providing `../../../../etc/passwd` would successfully escape the intended directory

### Missing Authorization Controls

- No permission checks beyond basic authentication
- Any authenticated user could modify templates
- No distinction between read/write/delete operations
- Public templates were modifiable (should be read-only)

## Security Fixes Implemented

### 1. Secure Path Validation Utility

**New File**: `backend/utils/path_validator.go`

Created three security functions:

#### `ValidateSecurePath(baseDir, userPath string) (string, error)`
- Rejects absolute paths from user input
- Normalizes the path with `filepath.Clean()`
- Joins with base directory
- Resolves to absolute path using `filepath.Abs()`
- Uses `filepath.Rel()` to verify the path stays within baseDir
- Returns error if path contains `..` or escapes the base directory

#### `SanitizeFilename(filename string) (string, error)`
- Removes all directory components from filenames
- Rejects paths containing `/`, `\`, or `..`
- Returns only the base filename
- Prevents hidden file manipulation

#### `ValidateSecurePathWithFilename(baseDir, dirPath, filename string) (string, error)`
- Combines directory and filename validation
- Useful for rename operations
- Ensures complete path is within allowed directory

### 2. Updated All Template Handlers

Applied secure path validation to all 6 vulnerable handlers:

#### **ListTemplatesHandler** (Line 156)
```go
fullPath, err := utils.ValidateSecurePath(baseDir, dir)
if err != nil {
    return c.JSON(http.StatusBadRequest, map[string]string{
        "error": "Invalid directory path",
    })
}
```

#### **GetTemplateContentHandler** (Line 202)
```go
fullPath, err := utils.ValidateSecurePath(baseDir, filePath)
if err != nil {
    return c.JSON(http.StatusBadRequest, map[string]string{
        "error": "Invalid file path",
    })
}
```

#### **SaveTemplateContentHandler** (Line 238)
- Added public template protection check
- Added secure path validation
```go
if !request.IsCustom {
    return c.JSON(http.StatusForbidden, map[string]string{
        "error": "Public templates cannot be modified",
    })
}
fullPath, err := utils.ValidateSecurePath(baseDir, request.Path)
```

#### **RenameTemplateHandler** (Line 357)
- Added public template protection check
- Validates old path with `ValidateSecurePath()`
- Sanitizes new filename with `SanitizeFilename()`
- Ensures new path stays within base directory
```go
if !req.IsCustom {
    return c.JSON(http.StatusForbidden, map[string]string{
        "error": "Public templates cannot be modified",
    })
}
oldFullPath, err := utils.ValidateSecurePath(baseDir, req.OldPath)
safeNewName, err := utils.SanitizeFilename(req.NewName)
```

#### **DeleteTemplateHandler** (Line 439)
- Added public template protection check
- Added secure path validation
```go
if !req.IsCustom {
    return c.JSON(http.StatusForbidden, map[string]string{
        "error": "Public templates cannot be deleted",
    })
}
fullPath, err := utils.ValidateSecurePath(baseDir, req.Path)
```

#### **ListAllTemplatesHandler** (Line 294)
- Added base directory existence validation
```go
if _, err := os.Stat(baseDir); os.IsNotExist(err) {
    return c.JSON(http.StatusNotFound, map[string]string{
        "error": "Templates directory not found",
    })
}
```

### 3. Permission-Based Access Control

**Modified File**: `backend/templates/routes.go`

Added granular permission checks using existing `middleware.RequirePermission()`:

```go
// Read operations - require "read" permission for "templates"
templatesGroup.GET("", ListTemplatesHandler, middleware.RequirePermission(app, "read", "templates"))
templatesGroup.GET("/content", GetTemplateContentHandler, middleware.RequirePermission(app, "read", "templates"))
templatesGroup.GET("/all", ListAllTemplatesHandler, middleware.RequirePermission(app, "read", "templates"))

// Write operations - require "write" permission for "templates"
templatesGroup.POST("/content", SaveTemplateContentHandler, middleware.RequirePermission(app, "write", "templates"))
templatesGroup.POST("/rename", RenameTemplateHandler, middleware.RequirePermission(app, "write", "templates"))

// Delete operations - require "delete" permission for "templates"
templatesGroup.POST("/delete", DeleteTemplateHandler, middleware.RequirePermission(app, "delete", "templates"))
```

### 4. Public Template Protection

Added explicit checks in modification handlers:
- `SaveTemplateContentHandler`: Rejects if `IsCustom == false`
- `RenameTemplateHandler`: Rejects if `IsCustom == false`
- `DeleteTemplateHandler`: Rejects if `IsCustom == false`

Public templates from the official nuclei-templates repository are now read-only.

## Security Benefits

### Defense in Depth

Multiple layers of security:
1. **Input Sanitization**: Remove dangerous characters and sequences
2. **Path Validation**: Verify paths stay within allowed directories
3. **Absolute Path Resolution**: Resolve symlinks and relative paths
4. **Permission Checks**: Enforce role-based access control
5. **Template Type Restrictions**: Protect public templates from modification

### Attack Prevention

 **Prevents Directory Traversal**: Attackers cannot escape template directories
 **Prevents Arbitrary File Access**: Cannot read/write/delete system files
 **Prevents Remote Code Execution**: Cannot write to executable locations
 **Enforces Least Privilege**: Users need proper permissions for operations
 **Protects System Integrity**: Public templates remain read-only
 **Comprehensive Logging**: All validation failures are logged

## Testing Recommendations

### Manual Security Testing

1. **Path Traversal Attempts**:
   ```bash
   # Should all be rejected with "Invalid path" error
   curl -X GET "http://localhost:8090/api/templates/content?path=../../../../etc/passwd"
   curl -X POST "http://localhost:8090/api/templates/content" -d '{"path":"../../malicious.yml","content":"evil"}'
   curl -X POST "http://localhost:8090/api/templates/delete" -d '{"path":"../../../../etc/hosts"}'
   ```

2. **Permission Enforcement**:
   - Test with "viewer" group user (should only read)
   - Test with user lacking "templates" permissions (should be denied)
   - Test write operations without "write" permission (should be denied)
   - Test delete operations without "delete" permission (should be denied)

3. **Public Template Protection**:
   ```bash
   # Should all be rejected with "Public templates cannot be modified" error
   curl -X POST "http://localhost:8090/api/templates/content" -d '{"path":"http/cves/2021/CVE-2021-1234.yaml","isCustom":false,"content":"modified"}'
   curl -X POST "http://localhost:8090/api/templates/rename" -d '{"oldPath":"http/cves/2021/CVE-2021-1234.yaml","newName":"hacked.yaml","isCustom":false}'
   curl -X POST "http://localhost:8090/api/templates/delete" -d '{"path":"http/cves/2021/CVE-2021-1234.yaml","isCustom":false}'
   ```

4. **Filename Sanitization**:
   ```bash
   # Should be rejected with "Invalid new name" error
   curl -X POST "http://localhost:8090/api/templates/rename" -d '{"oldPath":"test.yaml","newName":"../../../evil.yaml","isCustom":true}'
   curl -X POST "http://localhost:8090/api/templates/rename" -d '{"oldPath":"test.yaml","newName":"subdir/evil.yaml","isCustom":true}'
   ```

## Credits

Security vulnerability identified and reported by: chimmeee
Fixed by: ralphte
Date: November 3, 2025

## References

- OWASP Path Traversal: https://owasp.org/www-community/attacks/Path_Traversal
- CWE-22: Improper Limitation of a Pathname to a Restricted Directory: https://cwe.mitre.org/data/definitions/22.html
- Go filepath package documentation: https://pkg.go.dev/path/filepath

